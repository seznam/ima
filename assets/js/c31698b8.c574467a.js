"use strict";(globalThis.webpackChunk_ima_docs=globalThis.webpackChunk_ima_docs||[]).push([[5585],{3023:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>s});var t=r(3696);const a={},i=t.createContext(a);function o(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),t.createElement(i.Provider,{value:n},e.children)}},9361:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"server/performance","title":"Performance & Degradation","description":"Server > Performance optimization and graceful degradation","source":"@site/../docs/server/performance.md","sourceDirName":"server","slug":"/server/performance","permalink":"/server/performance","draft":false,"unlisted":false,"editUrl":"https://github.com/seznam/ima/tree/master/docs/../docs/server/performance.md","tags":[],"version":"current","lastUpdatedBy":"Miroslav Jancarik","lastUpdatedAt":1764074517000,"frontMatter":{"title":"Performance & Degradation","description":"Server > Performance optimization and graceful degradation"},"sidebar":"docs","previous":{"title":"Events","permalink":"/server/events"},"next":{"title":"Timing Performance Tracking","permalink":"/server/timing-tracking"}}');var a=r(2540),i=r(3023);const o={title:"Performance & Degradation",description:"Server > Performance optimization and graceful degradation"},s=void 0,d={},c=[{value:"SPA Prefetch Mode",id:"spa-prefetch-mode",level:2},{value:"How It Works",id:"how-it-works",level:3},{value:"Configuration",id:"configuration",level:3},{value:"Force SPA Prefetch in Development",id:"force-spa-prefetch-in-development",level:3},{value:"Degradation",id:"degradation",level:2},{value:"Degradation Keys",id:"degradation-keys",level:3},{value:"Basic Usage",id:"basic-usage",level:3},{value:"Array Degradation Functions",id:"array-degradation-functions",level:3},{value:"Pre-configured Degradation Helpers",id:"pre-configured-degradation-helpers",level:3},{value:"Available Helpers",id:"available-helpers",level:4},{value:"<code>createUserAgentDegradation(pattern)</code>",id:"createuseragentdegradationpattern",level:5},{value:"<code>createPathDegradation(pattern)</code>",id:"createpathdegradationpattern",level:5},{value:"<code>createHeaderDegradation(headerName, matcher?)</code>",id:"createheaderdegradationheadername-matcher",level:5},{value:"<code>combineAnd(...degradationFns)</code>",id:"combineanddegradationfns",level:5},{value:"<code>combineOr(...degradationFns)</code>",id:"combineordegradationfns",level:5},{value:"<code>invert(degradationFn)</code>",id:"invertdegradationfn",level:5},{value:"Sharing Degradation Logic",id:"sharing-degradation-logic",level:3}];function l(e){const n={admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",h5:"h5",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"spa-prefetch-mode",children:"SPA Prefetch Mode"}),"\n",(0,a.jsx)(n.p,{children:"SPA prefetch mode is a performance optimization technique that provides a middle ground between full server-side rendering (SSR) and pure single-page application (SPA) mode."}),"\n",(0,a.jsx)(n.h3,{id:"how-it-works",children:"How It Works"}),"\n",(0,a.jsx)(n.p,{children:"When enabled, the server:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Executes the full application lifecycle (controller, data fetching, etc.)"}),"\n",(0,a.jsx)(n.li,{children:"Serializes the page state and cache"}),"\n",(0,a.jsx)(n.li,{children:"Serves the SPA template with pre-fetched data included"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"The client then:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Boots instantly with the SPA template"}),"\n",(0,a.jsx)(n.li,{children:"Uses the pre-fetched state (no additional API calls needed)"}),"\n",(0,a.jsx)(n.li,{children:"Takes over with full client-side interactivity"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"This approach reduces server CPU load from HTML rendering while maintaining fast initial page loads with pre-fetched data."}),"\n",(0,a.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,a.jsxs)(n.p,{children:["Enable SPA prefetch mode by defining the ",(0,a.jsx)(n.code,{children:"isSPAPrefetch"})," degradation function in your server environment configuration:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",metastring:'title="server/config/environment.js"',children:"module.exports = {\n  prod: {\n    $Server: {\n      degradation: {\n        // Define degradation function to enable SPA prefetch mode\n        isSPAPrefetch: (event) => {\n          const userAgent = event.req.get('user-agent') || '';\n\n          return /Googlebot|Bingbot|SeznamBot/i.test(userAgent);\n        },\n      },\n    },\n  },\n};\n"})}),"\n",(0,a.jsx)(n.admonition,{type:"important",children:(0,a.jsxs)(n.p,{children:["The degradation function ",(0,a.jsx)(n.strong,{children:"MUST be defined"})," in order to use SPA prefetch mode. Simply defining the function enables the feature, and the function's return value determines when SPA prefetch mode is used."]})}),"\n",(0,a.jsx)(n.h3,{id:"force-spa-prefetch-in-development",children:"Force SPA Prefetch in Development"}),"\n",(0,a.jsx)(n.p,{children:"During development, you can force all requests to use SPA prefetch mode:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npx ima dev --forceSPAPrefetch\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This sets the ",(0,a.jsx)(n.code,{children:"IMA_CLI_FORCE_SPA_PREFETCH"})," environment variable, bypassing all conditions and always serving pages in SPA prefetch mode."]}),"\n",(0,a.jsx)(n.h2,{id:"degradation",children:"Degradation"}),"\n",(0,a.jsxs)(n.p,{children:["Degradation functions provide fine-grained control over server rendering behavior. They are ",(0,a.jsx)(n.strong,{children:"required"})," to enable different rendering modes (SSR, SPA, SPA prefetch, static pages) and allow you to conditionally switch between them based on runtime conditions like server load, user agents, request paths, or any custom logic."]}),"\n",(0,a.jsx)(n.h3,{id:"degradation-keys",children:"Degradation Keys"}),"\n",(0,a.jsxs)(n.p,{children:["The server supports the following degradation keys. ",(0,a.jsx)(n.strong,{children:"Defining a degradation function enables that mode"}),", and the function's return value determines when it's used:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.code,{children:"isSPAPrefetch"})}),": Enables and controls when to serve SPA prefetch pages (executes app lifecycle but renders SPA template with pre-fetched data)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.code,{children:"isSPA"})}),": Enables and controls when to serve pure SPA pages (no server-side execution)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.code,{children:"isOverloaded"})}),": Enables and controls when to show server overload message (503 status)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.code,{children:"isStatic"})}),": Enables and controls when to serve static error pages"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"basic-usage",children:"Basic Usage"}),"\n",(0,a.jsxs)(n.p,{children:["Degradation functions receive an event object containing ",(0,a.jsx)(n.code,{children:"req"}),", ",(0,a.jsx)(n.code,{children:"res"}),", ",(0,a.jsx)(n.code,{children:"context"}),", and ",(0,a.jsx)(n.code,{children:"environment"})," properties, and return ",(0,a.jsx)(n.code,{children:"true"})," when degradation should trigger:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",metastring:'title="server/config/environment.js"',children:"module.exports = {\n  prod: {\n    $Server: {\n      degradation: {\n        // Serve SPA prefetch for bots to improve SEO\n        isSPAPrefetch: (event) => {\n          const userAgent = event.req.get('user-agent') || '';\n\n          return /Googlebot|Bingbot|SeznamBot/i.test(userAgent);\n        },\n\n        // Serve SPA when server is under heavy load\n        isSPA: (event) => {\n          const { environment, context } = event;\n\n          // Example using @esmj/monitor - https://github.com/mjancarik/esmj-monitor\n          const { level } = context.performance.severity.getThreats();\n\n          return level === 'high' || level === 'critical';\n        },\n\n        // Show overload page for very high concurrency\n        isOverloaded: (event) => {\n          return process.env.IS_DOWN === 'true';\n        },\n\n        // Serve static error pages during maintenance\n        isStatic: (event) => {\n          return process.env.MAINTENANCE_MODE === 'true';\n        },\n      },\n    },\n  },\n};\n"})}),"\n",(0,a.jsx)(n.h3,{id:"array-degradation-functions",children:"Array Degradation Functions"}),"\n",(0,a.jsxs)(n.p,{children:["You can provide an ",(0,a.jsx)(n.strong,{children:"array of degradation functions"})," for more complex logic. Functions are evaluated in order, and degradation triggers when ",(0,a.jsxs)(n.strong,{children:["any function returns ",(0,a.jsx)(n.code,{children:"true"})]})," (OR logic):"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",metastring:'title="server/config/environment.js"',children:"module.exports = {\n  prod: {\n    $Server: {\n      degradation: {\n        isSPAPrefetch: [\n          // First check: Serve SPA prefetch for bots\n          (event) => {\n            const userAgent = event.req.get('user-agent') || '';\n\n            return /Googlebot|Bingbot|SeznamBot/i.test(userAgent);\n          },\n\n          // Second check: Serve SPA prefetch during peak hours\n          (event) => {\n            const hour = new Date().getUTCHours();\n\n            return hour >= 9 && hour <= 17; // 9 AM - 5 PM UTC\n          },\n\n          // Third check: Serve SPA prefetch for mobile devices\n          (event) => {\n            const userAgent = event.req.get('user-agent') || '';\n\n            return /Mobile|Android|iPhone/i.test(userAgent);\n          },\n        ],\n      },\n    },\n  },\n};\n"})}),"\n",(0,a.jsx)(n.admonition,{type:"important",children:(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Execution order matters"}),": The first function that returns ",(0,a.jsx)(n.code,{children:"true"})," triggers degradation immediately, and subsequent functions are not evaluated. This is useful for performance optimization."]})}),"\n",(0,a.jsx)(n.h3,{id:"pre-configured-degradation-helpers",children:"Pre-configured Degradation Helpers"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"@ima/server"})," package provides pre-configured degradation helpers to simplify common use cases. These can be shared across projects and combined to create complex degradation strategies:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",metastring:'title="server/config/environment.js"',children:"const {\n  createUserAgentDegradation,\n  createPathDegradation,\n  createHeaderDegradation,\n  combineAnd,\n  combineOr,\n  invert,\n} = require('@ima/server/degradation');\n\nmodule.exports = {\n  prod: {\n    $Server: {\n      degradation: {\n        // Serve SPA prefetch for bots\n        isSPAPrefetch: createUserAgentDegradation(\n          /Googlebot|Bingbot|SeznamBot/i,\n        ),\n\n        // Serve SPA for API endpoints only during POST requests\n        isSPA: combineAnd(\n          createPathDegradation(/^\\/api\\//),\n          (event) => event.req.method === 'POST',\n        ),\n\n        // Show overload during peak hours OR for 25% of traffic\n        isOverloaded: combineOr(\n          (event) => {\n            const hour = new Date().getUTCHours();\n\n            return hour >= 9 && hour <= 17; // 9 AM - 5 PM UTC\n          },\n          (event) => Math.random() * 100 < 25, // Sampling 25% of requests\n        ),\n\n        // Serve static pages for heavy operations, but not for authenticated users\n        isStatic: combineAnd(\n          createPathDegradation('/heavy-operation'),\n          invert(createHeaderDegradation('authorization')),\n        ),\n      },\n    },\n  },\n};\n"})}),"\n",(0,a.jsx)(n.h4,{id:"available-helpers",children:"Available Helpers"}),"\n",(0,a.jsx)(n.h5,{id:"createuseragentdegradationpattern",children:(0,a.jsx)(n.code,{children:"createUserAgentDegradation(pattern)"})}),"\n",(0,a.jsx)(n.p,{children:"Checks user agent string against a pattern (RegExp or function):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"// Using RegExp\nconst botDegradation = createUserAgentDegradation(\n  /Googlebot|Bingbot|SeznamBot/i,\n);\n\n// Using function\nconst customDegradation = createUserAgentDegradation((userAgent) => {\n  return userAgent.includes('Bot') || userAgent.includes('Spider');\n});\n"})}),"\n",(0,a.jsx)(n.h5,{id:"createpathdegradationpattern",children:(0,a.jsx)(n.code,{children:"createPathDegradation(pattern)"})}),"\n",(0,a.jsx)(n.p,{children:"Matches request paths (RegExp, string prefix, array of prefixes, or function):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"// Using RegExp\nconst apiDegradation = createPathDegradation(/^\\/api\\//);\n\n// Using string prefix\nconst adminDegradation = createPathDegradation('/admin');\n\n// Using array\nconst staticDegradation = createPathDegradation(['/static', '/assets']);\n\n// Using function\nconst complexDegradation = createPathDegradation((path) => {\n  return path.startsWith('/api/') && path.includes('/heavy-operation');\n});\n"})}),"\n",(0,a.jsx)(n.h5,{id:"createheaderdegradationheadername-matcher",children:(0,a.jsx)(n.code,{children:"createHeaderDegradation(headerName, matcher?)"})}),"\n",(0,a.jsx)(n.p,{children:"Checks request headers:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"// Check if header exists\nconst hasAuthDegradation = createHeaderDegradation('authorization');\n\n// Check header value (string)\nconst jsonDegradation = createHeaderDegradation(\n  'content-type',\n  'application/json',\n);\n\n// Check header value (RegExp)\nconst mobileDegradation = createHeaderDegradation(\n  'user-agent',\n  /Mobile|Android|iPhone/i,\n);\n\n// Check header value (function)\nconst customHeaderDegradation = createHeaderDegradation('x-custom', (value) => {\n  return value.length > 100;\n});\n"})}),"\n",(0,a.jsx)(n.h5,{id:"combineanddegradationfns",children:(0,a.jsx)(n.code,{children:"combineAnd(...degradationFns)"})}),"\n",(0,a.jsxs)(n.p,{children:["Combines functions with AND logic (all must return ",(0,a.jsx)(n.code,{children:"true"}),"):"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"const combinedDegradation = combineAnd(\n  createUserAgentDegradation(/Googlebot/i),\n  createPathDegradation('/products'),\n);\n"})}),"\n",(0,a.jsx)(n.h5,{id:"combineordegradationfns",children:(0,a.jsx)(n.code,{children:"combineOr(...degradationFns)"})}),"\n",(0,a.jsxs)(n.p,{children:["Combines functions with OR logic (any must return ",(0,a.jsx)(n.code,{children:"true"}),"):"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"const combinedDegradation = combineOr(\n  createUserAgentDegradation(/Bot/i),\n  createPathDegradation('/static'),\n);\n"})}),"\n",(0,a.jsx)(n.h5,{id:"invertdegradationfn",children:(0,a.jsx)(n.code,{children:"invert(degradationFn)"})}),"\n",(0,a.jsx)(n.p,{children:"Inverts a degradation function:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"const notBot = invert(createUserAgentDegradation(/Bot/i));\n"})}),"\n",(0,a.jsx)(n.h3,{id:"sharing-degradation-logic",children:"Sharing Degradation Logic"}),"\n",(0,a.jsx)(n.p,{children:"You can create your own degradation helpers and share them across projects:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",metastring:'title="shared/degradation.js"',children:"const {\n  createUserAgentDegradation,\n  combineOr,\n} = require('@ima/server/degradation');\n\n// Custom helper for your organization\nfunction createSEOBotDegradation() {\n  return createUserAgentDegradation(\n    /Googlebot|Bingbot|SeznamBot|DuckDuckBot|Baiduspider|YandexBot/i,\n  );\n}\n\n// Custom helper for mobile detection\nfunction createMobileDeviceDegradation() {\n  return createUserAgentDegradation(\n    /Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile/i,\n  );\n}\n\n// Export for reuse\nmodule.exports = {\n  createSEOBotDegradation,\n  createMobileDeviceDegradation,\n};\n"})}),"\n",(0,a.jsx)(n.p,{children:"Then use them in your environment configuration:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",metastring:'title="server/config/environment.js"',children:"const {\n  createSEOBotDegradation,\n  createMobileDeviceDegradation,\n} = require('../shared/degradation');\nconst { combineOr } = require('@ima/server/degradation');\n\nmodule.exports = {\n  prod: {\n    $Server: {\n      degradation: {\n        // Serve SPA prefetch for SEO bots OR mobile devices\n        isSPAPrefetch: combineOr(\n          createSEOBotDegradation(),\n          createMobileDeviceDegradation(),\n        ),\n      },\n    },\n  },\n};\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}}}]);